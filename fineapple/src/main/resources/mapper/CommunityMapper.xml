<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.fineapple.mapper.CommunityMapper">

	<resultMap type="Board" id="boardMap">
		<result property="postNo" column="post_no"/>
		<result property="user.userId" column="user_id" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="postDate" column="post_date" />
		<result property="viewCount" column="view_count" />
		<result property="cmntCount" column="cmnt_count" />
		<result property="postLikeCount" column="post_like_count" />
		<result property="updateStt" column="update_stt"/>
		<result property="cateName" column="post_cate"/>
		<result property="groupNo" column="group_no"/>
	</resultMap>
	

	<resultMap type="Cmnt" id="cmntMap">
	<result property="cmntNo" column=""/>
	<result property="board.boardNo" column=""/>
	<result property="user.userId" column=""/>
	<result property="cmntContent" column=""/>
	<result property="cmntDate" column=""/>
	<result property="cmntLikeCount" column=""/>
	<result property="updateStt" column=""/>
	</resultMap>
	
	<sql id="orderBy">
	ORDER BY post_no
	</sql>
	

	<insert id="addPost" parameterType="board">
		<selectKey keyProperty="postNo" resultType="int" order="AFTER">
		SELECT seq_board_post_no.CURRVAL FROM dual
		</selectKey>
		INSERT INTO BOARD (
		POST_NO,
		USER_ID,
		GROUP_NO,
		POST_CATE,
		UPDATE_STT,
		TITLE, 
		CONTENT,
		POST_DATE
		)
		VALUES (
		seq_board_post_no.NEXTVAL,
		#{user.userId},
		<if test="groupNo == 0">
		null,
		</if>
		<if test="groupNo != 0">
		#{groupNo},
		</if>
		#{cateName},
		#{updateStt},
		#{title},
		#{content},
		#{postDate}
		)
	</insert>
	
	<select id="getPostList" resultMap="boardMap">
	SELECT
	*
	FROM
	board	
	<include refid="orderBy"></include>
	</select>
	
	<update id="updatePostViewCount" parameterType="board">
	<selectKey keyProperty="postNo">
	</selectKey>
	UPDATE BOARD 
	<set>
	VIEW_COUNT = NVL(VIEW_COUNT,0) + 1
	</set>
	<trim prefix="WHERE" prefixOverrides="AND | OR">
	post_no = #{postNo}
	</trim>
	</update>
	
	<update id="updatePostLike" parameterType="map">
	UPDATE
	INTO
	board
	<trim prefix="SET" suffixOverrides=",">
	<if test="flag == 0">
	POST_LIKE_COUNT = POST_LIKE_COUNT + 1
	</if>
	<if test="flag == 1">
	POST_LIKE_COUNT = POST_LIKE_COUNT - 1
	</if>
	</trim>
	<where> 
	post_no = #{board.postNo}
	</where>
	</update>
	
	<update id="updateCmntLike" parameterType="map">
	UPDATE
	INTO
	cmnt
	<trim prefix="SET" suffixOverrides=",">
	<if test="flag == 0">
	POST_LIKE_COUNT = POST_LIKE_COUNT + 1
	</if>
	<if test="flag == 1">
	POST_LIKE_COUNT = POST_LIKE_COUNT - 1
	</if>
	</trim>
	<where> 
	post_no = #{board.postNo}
	</where>
	</update>
	
	<insert id="addCmnt" parameterType="cmnt">
	INSERT INTO COMMENTS 
	(
	CMNT_NO, 
	POST_NO,
	CMNT_USER_ID, 
	UPDATE_STT, 
	CMNT_CONTENT, 
	CMNT_DATE
	) 
	VALUES
	(
	seq_comments_cmnt_no,
	#{board.postNo},
	#{user.userId},
	#{updateStt},
	#{cmntContenct},
	#{cmntDate}
	)
	</insert>
	
	<update id="updatePost" parameterType="board">
	<selectKey  order="AFTER"></selectKey>
	UPDATE BOARD
	<set>
	SET TITLE = #{title}
	CONTENT = #{content}
	</set>
	<trim prefix="WHERE" prefixOverrides="WHERE | OR">
	post_no = #{postNo}
	</trim>
	</update>
	
	<update id="updateCmnt" parameterType="Cmnt">
	UPDATE COMMENTS 
	<set>
	CMNT_CONTENT = #{cmntContent}
	</set>
	<where>
	cmnt_no = #{cmntNo}
	</where>
	</update>
	
	
	
</mapper>
