<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.fineapple.mapper.CommunityMapper">

	<resultMap type="board" id="boardMap">
		<result property="postNo" column="post_no"/>
		<result property="user.userId" column="user_id" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="postDate" column="post_date" />
		<result property="viewCount" column="view_count" />
		<result property="cmntCount" column="cmnt_count" />
		<result property="postLikeCount" column="post_like_count" />
		<result property="updateStt" column="update_stt"/>
		<result property="cateName" column="post_cate"/>
		<result property="groupNo" column="group_no"/>
	</resultMap>
	

	<resultMap type="cmnt" id="cmntMap">
	<result property="cmntNo" column="cmnt_no"/>
	<result property="board.postNo" column="post_no"/>
	<result property="user.userId" column="cmnt_user_id"/>
	<result property="cmntContent" column="cmnt_content"/>
	<result property="cmntDate" column="cmnt_date"/>
	<result property="cmntLikeCount" column="cmnt_like_count"/>
	<result property="updateStt" column="update_stt"/>
	</resultMap>
	
	<resultMap type="group" id="groupMap">
	<result property="groupNo" column="group_no"/>
	<result property="groupName" column="group_name"/>
	<result property="groupIntro" column="group_intro"/>
	<result property="birthDate" column="group_birth"/>
	</resultMap>
	
	<resultMap type="groupUser" id="groupUserMap">
	<result property="groupUserNo" column="group_user_no"/>
	<result property="group.groupNo" column="group_no"/>
	<result property="user.userId" column="user_id"/>
	<result property="userStt" column="group_stt"/>
	<result property="userCaptainStt" column="captain_stt"/>
	</resultMap>
	
	<sql id="orderByPostNo">
	ORDER BY post_no
	</sql>
	

	<insert id="addPost" parameterType="board">
		<selectKey keyProperty="postNo" resultType="int" order="AFTER">
		SELECT seq_board_post_no.CURRVAL FROM dual
		</selectKey>
		
		INSERT INTO BOARD (
		POST_NO,
		USER_ID,
		GROUP_NO,
		POST_CATE,
		UPDATE_STT,
		TITLE, 
		CONTENT,
		POST_DATE
		)
		VALUES (
		seq_board_post_no.NEXTVAL,
		#{user.userId},
		<if test="groupNo == 0">
		null,
		</if>
		<if test="groupNo != 0">
		#{groupNo},
		</if>
		#{cateName},
		#{updateStt},
		#{title},
		#{content},
		#{postDate}
		)
	</insert>

	<insert id="addCmnt" parameterType="cmnt">
	INSERT INTO COMMENTS 
	(
	CMNT_NO, 
	POST_NO,
	CMNT_USER_ID, 
	UPDATE_STT, 
	CMNT_CONTENT, 
	CMNT_DATE
	) 
	VALUES
	(
	seq_comments_cmnt_no,
	#{board.postNo},
	#{user.userId},
	#{updateStt},
	#{cmntContenct},
	#{cmntDate}
	)
	</insert>
	
	<!-- //////////////////////////////////////////////////////// -->

	<select id="getPostList" resultMap="boardMap">
	SELECT
	b.post_no,
	b.user_id,
	b.update_stt,
	b.title,
	b.content,
	b.post_date,
	b.post_like_count,
	b.view_count,
	c.cmnt_count
	FROM
	board b,
	(
	SELECT COUNT(*)
	cmnt_count,
	c.post_no
	FROM board b, comments c
	WHERE b.post_no = c.post_no
	GROUP BY c.post_no
	) c
	<trim prefix="WHERE" prefixOverrides="AND | OR" suffixOverrides=",">
	b.post_no = c.post_no(+)
	</trim>
	<include refid="orderByPostNo"/>
	</select>
	
	<select id="getPost" parameterType="board" resultMap="boardMap">
	SELECT
	post_no,
	user_id,
	group_no,
	post_cate,
	update_stt,
	title,
	content,
	post_date,
	post_like_count,
	view_count
	FROM
	board
	<where>
	post_no = #{postNo}
	</where>
	</select>
	
	<select id="getCmntList" parameterType="board" resultMap="cmntMap">
	SELECT
	*
	FROM
	comments
	<trim prefix="WHERE" prefixOverrides="AND | OR">
	post_no = #{postNo}
	</trim>
	</select>
	
	<!-- //////////////////////////////////////////////////////// -->
	
	<update id="updatePostViewCount" parameterType="board">
	UPDATE BOARD 
	<set>
	VIEW_COUNT = NVL(VIEW_COUNT,0) + 1
	</set>
	<trim prefix="WHERE" prefixOverrides="AND | OR">
	post_no = #{postNo}
	</trim>
	</update>
	
	<!-- //////////////////////////////////////////////////////// -->
	
	<update id="updatePostLike" parameterType="map">
	UPDATE
	INTO
	board
	<trim prefix="SET" suffixOverrides=",">
	<if test="flag == 0">
	POST_LIKE_COUNT = POST_LIKE_COUNT + 1
	</if>
	<if test="flag == 1">
	POST_LIKE_COUNT = POST_LIKE_COUNT - 1
	</if>
	</trim>
	<where> 
	post_no = #{postNo}
	</where>
	</update>

	<update id="updateCmntLike" parameterType="map">
	UPDATE
	INTO
	comments
	<trim prefix="SET" suffixOverrides=",">
	<if test="flag == 0">
	POST_LIKE_COUNT = POST_LIKE_COUNT + 1
	</if>
	<if test="flag == 1">
	POST_LIKE_COUNT = POST_LIKE_COUNT - 1
	</if>
	</trim>
	<where> 
	post_no = #{board.postNo}
	</where>
	</update>
	
	<!-- //////////////////////////////////////////////////////// -->
	
	
	<update id="updatePost" parameterType="board">
	<selectKey  order="AFTER"></selectKey>
	UPDATE BOARD
	<set>
	SET TITLE = #{title}
	CONTENT = #{content}
	</set>
	<trim prefix="WHERE" prefixOverrides="WHERE | OR">
	post_no = #{postNo}
	</trim>
	</update>
	
	<update id="updateCmnt" parameterType="Cmnt">
	UPDATE COMMENTS 
	<set>
	CMNT_CONTENT = #{cmntContent}
	</set>
	<where>
	cmnt_no = #{cmntNo}
	</where>
	</update>
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	<insert id="addGroup">
	<selectKey keyProperty="groupNo" keyColumn="group_no" resultType="int" order="AFTER">
	SELECT seq_groups_groups_no.NEXTVAL.CURRVAL FROM dual
	</selectKey>
	INSERT
	INTO
	groups
	(
	GROUP_NO, 
	GROUP_NAME,
	GROUP_INTRO, 
	GROUP_BIRTH
	) 
	VALUES 
	(
	seq_groups_groups_no.NEXTVAL,
	#{groupName},
	#{groupIntro},
	SYSDATE
	)
	</insert>
	
	<insert id="addGroupUser" parameterType="groupUser">
	INSERT
	INTO
	group_user
	(
	group_user_no,
	group_no,
	user_id,
	captain_stt,
	group_stt
	)
	VALUES
	(
	seq_group_user_no.NEXTVAL,
	#{groupNo},
	#{user.userId},
	#{captainStt},
	#{groupStt}
	)
	</insert>
	
	<delete id="deleteGroupUser" parameterType="groupUser">
	DELETE
	FROM
	group_user
	<where>
	user_id = #{user.userId}
	</where>
	</delete>
	
	
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	<select id="getGroupList" resultMap="groupMap">
	SELECT
	*
	FROM
	groups
	</select>
	
	<select id="getGroup" parameterType="group" resultMap="groupMap">
	SELECT
	*
	FROM
	<where>
	group_no = #{groupNo}
	</where>
	</select>
	
	<!-- //////////////////////////////////////////////////////// -->
	
	<select id="getGroupUserList" parameterType="group" resultMap="groupUserMap">
	SELECT
	*
	FROM
	group_user
	<trim prefix="WHERE" prefixOverrides="AND | OR">
	group_no = #{groupNo}
	</trim>
	</select>
	
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	<select id="getMyGroupList" parameterType="groupUser" resultMap="groupMap">
	SELECT
	g.group_no,
	g.group_name,
	g.group_intro,
	g.group_birth
	FROM
	groups g,
	group_user gu
	<trim prefix="WHERE" prefixOverrides="AND|OR" suffixOverrides=",">
	gu.user_id = #{user.userId},
	gu.group_no = g.group_no
	</trim>
	</select>
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	
	<!-- //////////////////////////////////////////////////////// -->
	
	
</mapper>
